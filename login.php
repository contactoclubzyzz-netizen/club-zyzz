<?php ini_set('display_errors', 1); ini_set('display_startup_errors', 1); error_reporting(E_ALL); session_start(); require 'conexion.php'; // Si ya hay sesión iniciada, redirige al panel if (isset($_SESSION['usuario_id'])) { // Verificar si ya tiene datos corporales $usuario_id = $_SESSION['usuario_id']; $query2 = "SELECT COUNT(*) as total FROM datos_corporales WHERE usuario_id = ?"; $stmt2 = $conexion->prepare($query2); $stmt2->bind_param("i", $usuario_id); $stmt2->execute(); $stmt2->bind_result($tiene_datos); $stmt2->fetch(); $stmt2->close(); if ($tiene_datos > 0) { header("Location: panel_usuario.php"); } else { header("Location: sexo.php"); } exit(); } $error = ""; if ($_SERVER['REQUEST_METHOD'] === 'POST') { $email = trim($_POST['email']); $password = trim($_POST['contrasena']); // Buscar usuario por email $query = "SELECT idPrimaria, contrasena FROM usuarios WHERE email = ?"; $stmt = $conexion->prepare($query); if (!$stmt) { die("Error en la preparación de la consulta: " . $conexion->error); } $stmt->bind_param("s", $email); $stmt->execute(); // Obtener resultado como array asociativo $result = $stmt->get_result(); if ($result->num_rows > 0) { $row = $result->fetch_assoc(); $usuario_id = $row['id']; $hashed_password = $row['contrasena']; if (password_verify($password, $hashed_password)) { $_SESSION['usuario_id'] = $usuario_id; // Verificar si el usuario ya tiene sus datos corporales $query2 = "SELECT COUNT(*) as total FROM datos_corporales WHERE usuario_id = ?"; $stmt2 = $conexion->prepare($query2); $stmt2->bind_param("i", $usuario_id); $stmt2->execute(); $stmt2->bind_result($tiene_datos); $stmt2->fetch(); $stmt2->close(); // Redirigir según tenga o no datos if ($tiene_datos > 0) { header("Location: panel_usuario.php"); } else { header("Location: sexo.php"); } exit(); } else { $error = "Correo o contraseña incorrectos."; } } else { $error = "Correo o contraseña incorrectos."; } $stmt->close(); } ?> <!DOCTYPE html> <html lang="es"> <head> <meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>CLUB ZYZZ – Iniciar Sesión</title> <link rel="stylesheet" href="css/estilo.css"> </head> <body> <h1>CLUB ZYZZ</h1> <h2>Inicia sesión y transforma tu físico</h2> <div class="register-box"> <?php if (!empty($error)): ?> <p style="color:red; font-weight:bold; text-align:center; margin-bottom:15px;"> <?= htmlspecialchars($error) ?> </p> <?php endif; ?> <form method="POST" action=""> <input type="email" name="email" placeholder="Correo electrónico" required /> <input type="password" name="contrasena" placeholder="Contraseña" required /> <button type="submit">INICIAR SESIÓN</button> </form> <div class="back-link"> ¿No tienes una cuenta? — <a href="registro.php">Registrarse</a> </div> </div> </body> </html>

